name: Continuous Integration

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

env:
  GH_TOKEN: ${{ github.token }}
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"
  RUSTDOCFLAGS: "-Dwarnings"
  AUTO_FORMAT: ${{ vars.AUTO_FORMAT }}
  PR_NUMBER: ${{ github.event.pull_request.number }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # - name: Cache cargo registry
    #   uses: actions/cache@v4
    #   with:
    #     path: |
    #       ~/.cargo
    #       ~/.rustup
    #       target
    #     key: ${{ runner.os }}-cargo-${{ hashFiles('./Cargo.lock') }}
    #     restore-keys: |
    #       ${{ runner.os }}-cargo-

    - name: Cache cargo bin
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
        key: ${{ runner.os }}-cargo-bin

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache target
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-target-

    - name: Add Rust to PATH
      run: |
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        echo "$HOME/.rustup/bin" >> $GITHUB_PATH

    - name: Install Rust nightly
      run: |
        echo "Installing rustup..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

        rustup component add --toolchain nightly-x86_64-unknown-linux-gnu clippy rustfmt llvm-tools-preview

        if [ ! -f "$HOME/.cargo/bin/cargo-llvm-cov" ]; then
            echo "cargo llvm-cov is not installed. Installing via cargo..."
            cargo install cargo-llvm-cov
        fi
        if [ ! -f "$HOME/.cargo/bin/cargo-set-version" ]; then
            echo "cargo set-version is not installed. Installing via cargo..."
            cargo install cargo-edit
        fi

    - name: Show rust version
      run: rustc --version

    - name: Format code
      if: env.AUTO_FORMAT == 'true'
      run: cargo +nightly fmt --all

    - name: Check formatting
      if: env.AUTO_FORMAT != 'true'
      run: |
        cargo +nightly fmt --all --check || {
          echo "Formatting failed â€” please run 'cargo +nightly fmt --all' locally before pushing.";
          exit 1;
        }
    
    # Allow dirty flag added for convinience. Be careful when auto-formatting is enabled.
    - name: Clippy apply suggestions
      if: env.AUTO_FORMAT == 'true'
      run: RUSTFLAGS="-Dclippy::all" cargo +nightly clippy --all-targets --all-features --fix --allow-dirty

    # Still need to run clippy as well, because cargo clippy fix makes errors into warnings. See: https://github.com/rust-lang/rust-clippy/discussions/9979
    - name: Clippy
      run: RUSTFLAGS="-Dclippy::all" cargo +nightly clippy --all-targets --all-features

    # Replaces cargo test and checks test coverage.
    - name: Test coverage
      run: |
        cargo +nightly llvm-cov clean --workspace;
        cargo +nightly llvm-cov --no-report --workspace --all-features --all-targets;
        cargo +nightly llvm-cov --no-report --workspace --all-features --doctests;
        cargo +nightly llvm-cov report --fail-under-regions 40;
        
    # Needed to catch dangling references in documentation.
    - name: Build documentation
      run: cargo +nightly doc --no-deps;

    - name: Add master to worktree
      run: |
        git fetch origin master
        git worktree add master origin/master

    - name: Show API diff
      run: |
        cargo test public_api::tests::print_changes -- --nocapture --ignored

    - name: Check SemVer
      if: env.ACT != 'true'
      run: |
        # Fetch current labels
        labels=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')

        # Check for "auto semver"auto semver" && echo "yes" || echo
        has_auto_semver=$(echo "$labels" | grep -qx " "no")

        # Check if any version labels exist
        has_version_label=$(echo "$labels" | grep -E -qx "(patch|minor|major)" && echo "yes" || echo "no")

        # Decide whether to run automation
        if [ "$has_version_label" = "yes" ] && [ "$has_auto_semver" = "no" ]; then
            echo "Manual version label detected. Skipping automation."
            exit 0
        elif [ "$has_auto_semver" = "no" ]; then
          gh pr edit "$PR_NUMBER" --add-label "auto semver"
        fi

        gh pr edit "$PR_NUMBER" --remove-label "patch" --remove-label "minor" --remove-label "major"

        if cargo test public_api::tests::is_patch -- --ignored; then
            gh pr edit "$PR_NUMBER" --add-label "patch"
        elif cargo test public_api::tests::is_minor -- --ignored; then
            gh pr edit "$PR_NUMBER" --add-label "minor"
        else
            gh pr edit "$PR_NUMBER" --add-label "major"
        fi

    - name: Remove master from worktree
      run: git worktree remove master